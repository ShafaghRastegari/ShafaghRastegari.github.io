---
interface Props {
	repo: string // Format: "owner/repo"
	description?: string // Custom description (overrides GitHub description)
	tools?: string[] // Array of tools/technologies used
	languages?: string[] // Array of programming languages used
	class?: string
}

const { repo, description, tools, languages, class: className = '' } = Astro.props
const [owner, repoName] = repo.split('/')
const repoUrl = `https://github.com/${repo}`

// Language colors
const languageColors: Record<string, string> = {
	JavaScript: '#f1e05a',
	TypeScript: '#2b7489',
	Python: '#3572A5',
	Java: '#b07219',
	'C++': '#f34b7d',
	C: '#555555',
	'C#': '#239120',
	Go: '#00ADD8',
	Rust: '#dea584',
	PHP: '#4F5D95',
	Ruby: '#701516',
	Swift: '#ffac45',
	Kotlin: '#A97BFF',
	Dart: '#00B4AB',
	HTML: '#e34c26',
	CSS: '#563d7c',
	Shell: '#89e051',
	'Jupyter Notebook': '#DA5B0B'
}

// Fetch repo info at build time with caching
let repoData: any = null
let repoLanguages: string[] = []

// Cache helper functions
import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs'
import { join } from 'path'

const cacheDir = join(process.cwd(), '.cache', 'github-api')
const getCachePath = (type: 'repo' | 'languages', repo: string) => {
	const safeRepo = repo.replace(/\//g, '_')
	return join(cacheDir, `${type}_${safeRepo}.json`)
}

// Ensure cache directory exists
try {
	if (!existsSync(cacheDir)) {
		mkdirSync(cacheDir, { recursive: true })
	}
} catch (e) {
	// Ignore cache directory creation errors
}

// Try to load from cache first
const repoCachePath = getCachePath('repo', repo)
const languagesCachePath = getCachePath('languages', repo)

try {
	// Try loading from cache
	if (existsSync(repoCachePath)) {
		const cachedRepo = JSON.parse(readFileSync(repoCachePath, 'utf-8'))
		repoData = cachedRepo
	}
	if (existsSync(languagesCachePath)) {
		const cachedLanguages = JSON.parse(readFileSync(languagesCachePath, 'utf-8'))
		if (cachedLanguages && typeof cachedLanguages === 'object' && !Array.isArray(cachedLanguages)) {
			const keys = Object.keys(cachedLanguages)
			repoLanguages = keys.filter(key => {
				const value = cachedLanguages[key]
				return typeof key === 'string' && 
				       typeof value === 'number' && 
				       !key.includes('/') && 
				       key.trim().length > 0
			})
		}
	}
} catch (e) {
	// If cache read fails, continue to API fetch
}

// Only fetch from API if we don't have cached data
if (!repoData || repoLanguages.length === 0) {
	try {
		// Use GitHub token if available (from environment variable)
		const githubToken = import.meta.env.GITHUB_TOKEN
		const headers: HeadersInit = githubToken 
			? { 
				'Authorization': `token ${githubToken}`,
				'User-Agent': 'Astro-CV-Site'
			}
			: {}
		
		const [repoResponse, languagesResponse] = await Promise.all([
			fetch(`https://api.github.com/repos/${repo}`, { headers }),
			fetch(`https://api.github.com/repos/${repo}/languages`, { headers })
		])
		
		if (repoResponse.ok) {
			repoData = await repoResponse.json()
			// Cache the response
			try {
				writeFileSync(repoCachePath, JSON.stringify(repoData, null, 2))
			} catch (e) {
				// Ignore cache write errors
			}
		} else if (!repoData) {
			console.warn(`Failed to fetch repo data for ${repo}: ${repoResponse.status}`)
		}
		
		if (languagesResponse.ok) {
			const languagesData = await languagesResponse.json()
			// GitHub API returns: { "Python": 12345, "JavaScript": 6789 }
			// Check if it's an error response
			if (languagesData && typeof languagesData === 'object' && !Array.isArray(languagesData)) {
				if (languagesData.message || languagesData.error) {
					console.warn(`GitHub API returned error for languages: ${languagesData.message || languagesData.error}`)
				} else {
					// Cache the response
					try {
						writeFileSync(languagesCachePath, JSON.stringify(languagesData, null, 2))
					} catch (e) {
						// Ignore cache write errors
					}
					
					const keys = Object.keys(languagesData)
					repoLanguages = keys.filter(key => {
						const value = languagesData[key]
						return typeof key === 'string' && 
						       typeof value === 'number' && 
						       !key.includes('/') && 
						       key.trim().length > 0
					})
				}
			}
		} else if (repoLanguages.length === 0) {
			console.warn(`Failed to fetch languages for ${repo}: ${languagesResponse.status} ${languagesResponse.statusText}`)
		}
	} catch (error) {
		console.warn(`Failed to fetch repo data for ${repo}:`, error)
	}
}

// Determine which languages to display
// Priority: 1. Manual languages prop, 2. Fetched repoLanguages, 3. Primary language from repoData
let displayLanguages: string[] = []
if (languages && languages.length > 0) {
	displayLanguages = languages
} else if (repoLanguages.length > 0) {
	// Use the languages directly from GitHub API (they're already validated)
	displayLanguages = repoLanguages
} else if (repoData?.language) {
	// Fallback to primary language from repo data
	// Only use it if it's a valid language name (not a repo path)
	const primaryLang = repoData.language
	if (primaryLang && typeof primaryLang === 'string' && !primaryLang.includes('/')) {
		displayLanguages = [primaryLang]
	}
}
---

<a
	href={repoUrl}
	target='_blank'
	rel='noopener noreferrer'
	class={`group relative w-full cursor-pointer overflow-hidden rounded-2xl border border-border bg-primary-foreground p-6 transition-all hover:border-[hsl(var(--accent-color))]/40 hover:shadow-lg hover:shadow-[hsl(var(--accent-color))]/10 ${className}`}
>
	<div class='flex flex-col gap-y-3'>
		<div class='flex items-center gap-x-3'>
			<svg
				xmlns='http://www.w3.org/2000/svg'
				width='24'
				height='24'
				viewBox='0 0 24 24'
				fill='none'
				stroke='currentColor'
				stroke-width='2'
				stroke-linecap='round'
				stroke-linejoin='round'
				class='text-foreground'
			>
				<path d='M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4' />
				<path d='M9 18c-4.51 2-5-2-7-2' />
			</svg>
			<h3 class='text-xl font-semibold text-foreground'>{repoName}</h3>
		</div>
		{(description || repoData?.description) && (
			<p class='text-muted-foreground'>{description || repoData?.description}</p>
		)}
		<div class='flex items-center gap-x-4 text-sm text-muted-foreground flex-wrap'>
			{displayLanguages.length > 0 && displayLanguages.map((lang) => {
				// Final safety check - never display repo name or path
				if (lang === repo || lang === repoName || lang === owner || lang.includes('/')) {
					return null
				}
				const langColor = languageColors[lang] || '#586e75'
				return (
					<span class='flex items-center gap-x-1'>
						<span
							class='h-3 w-3 rounded-full'
							style={`background-color: ${langColor}`}
						></span>
						{lang}
					</span>
				)
			})}
		</div>
		{tools && tools.length > 0 && (
			<div class='flex flex-wrap items-center gap-2 pt-2'>
				<span class='text-sm font-medium text-muted-foreground'>Tools:</span>
				{tools.map((tool) => (
					<span
						class='rounded-md border border-border/50 bg-secondary px-2 py-1 text-xs text-foreground/90 font-medium'
						style='background-color: hsl(var(--badge));'
					>
						{tool}
					</span>
				))}
			</div>
		)}
	</div>
	<div class='absolute inset-0 flex items-center justify-center bg-background/80 opacity-0 transition-opacity group-hover:opacity-100'>
		<div class='flex items-center gap-x-2 text-lg font-semibold'>
			<svg
				xmlns='http://www.w3.org/2000/svg'
				width='24'
				height='24'
				viewBox='0 0 24 24'
				fill='none'
				stroke='currentColor'
				stroke-width='2'
				stroke-linecap='round'
				stroke-linejoin='round'
			>
				<path d='M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4' />
				<path d='M9 18c-4.51 2-5-2-7-2' />
			</svg>
			<span>View on GitHub</span>
		</div>
	</div>
</a>
